<app-header></app-header>

<div class="dashboard-layout-root d-flex position-relative min-vh-100">
  <!-- Main Content -->
  <div
    class="content-area flex-grow-1 transition-all"
    [class.sidebar-offset]="isSidebarOpen()"
    [class.sidebar-collapsed]="!isSidebarOpen()"
  >
    <!-- Top Utility Bar (Search & User) -->
    <div
      class="utility-bar px-4 py-3 d-flex justify-content-between align-items-center bg-white border-bottom mb-4"
    >
      <div class="d-flex align-items-center gap-3">
        <div class="d-flex flex-column justify-content-center">
          <h1 class="fw-bold m-0 h5">
            {{ langService.isAr() ? 'لوحة التحكم المالية' : 'Financial Dashboard' }}
          </h1>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button
          class="btn btn-light-soft border p-2 px-3 rounded-3 shadow-sm text-danger"
          (click)="onLogout()"
          [title]="langService.isAr() ? 'تسجيل الخروج' : 'Logout'"
        >
          <i class="bi bi-box-arrow-right fs-5"></i>
        </button>
        <button class="btn btn-dark-felosy p-2 px-3 shadow-lg" (click)="showSetupDialog.set(true)">
          <i class="bi bi-gear fs-5"></i>
        </button>
      </div>
    </div>

    <div class="container-fluid py-4 px-4 px-lg-5">
      <div class="d-flex justify-content-between align-items-center mb-5">
        <div class="d-flex align-items-center gap-3">
          <div
            class="bg-dark rounded-3 p-2 d-flex align-items-center justify-content-center shadow-lg"
            style="width: 46px; height: 46px"
          >
            <i class="bi bi-grid-fill text-white fs-4"></i>
          </div>
          <div>
            <h1 class="fw-bold m-0 h4">
              {{ langService.isAr() ? 'نظرة عامة' : 'Overview' }}
            </h1>
            <p class="text-secondary small m-0">{{ getContent().subtitle }}</p>
          </div>
        </div>
      </div>

      @if (boardService.isLoading()) {
        <div class="d-flex justify-content-center py-5">
          <div class="spinner-border text-dark" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      } @else if (boardService.currentBoard()) {
        <!-- Summary Section -->
        <app-summary-cards></app-summary-cards>

        <!-- Wallets Section -->
        <app-wallet-grid [wallets]="wallets()"></app-wallet-grid>

        <!-- Lower Sections (Alerts & Obligations) -->
        <div class="row g-5 mt-2">
          <div class="col-lg-8">
            <!-- Upcoming Payments/Obligations -->
            <div class="section-label d-flex justify-content-between align-items-center mb-4">
              <h5 class="fw-bold m-0">
                {{ langService.isAr() ? 'الالتزامات القادمة' : 'Upcoming Obligations' }}
              </h5>
              <button
                class="btn btn-dark-felosy rounded-pill p-1 px-4 fs-xs fw-bold d-flex align-items-center gap-2"
                (click)="showAddDialog.set(true)"
              >
                <i class="bi bi-plus"></i>
                <span>{{ langService.isAr() ? 'إضافة التزام' : 'Add Obligation' }}</span>
              </button>
            </div>
            <app-obligation-list></app-obligation-list>
          </div>

          <div class="col-lg-4">
            <!-- System Alerts -->
            <div class="alert-section">
              <div class="section-label mb-4 d-flex align-items-center gap-2">
                <i class="bi bi-shield-check text-secondary"></i>
                <h5 class="fw-bold m-0">
                  {{ langService.isAr() ? 'تنبيهات النظام' : 'System Alerts' }}
                </h5>
              </div>

              <div class="alert-cards d-flex flex-column gap-3">
                <div
                  class="alert-item p-3 bg-white rounded-4 shadow-soft border-0 d-flex align-items-center gap-3"
                >
                  <div class="alert-icon bg-soft-red text-red p-2 rounded-circle">
                    <i class="bi bi-exclamation-triangle"></i>
                  </div>
                  <div class="alert-text small">
                    {{
                      langService.isAr()
                        ? 'في الأسبوع الأول تجاوزت ميزانية المشتريات'
                        : 'In week 1, shopping budget was exceeded'
                    }}
                  </div>
                </div>
                <div
                  class="alert-item p-3 bg-white rounded-4 shadow-soft border-0 d-flex align-items-center gap-3"
                >
                  <div class="alert-icon bg-soft-orange text-orange p-2 rounded-circle">
                    <i class="bi bi-clock-history"></i>
                  </div>
                  <div class="alert-text small">
                    {{
                      langService.isAr()
                        ? 'لديك التزام مستحق خلال 3 أيام'
                        : 'You have an obligation due in 3 days'
                    }}
                  </div>
                </div>
              </div>

              <!-- Decision Card -->
              <div
                class="decision-card mt-5 p-4 bg-dark-felosy text-white rounded-4 position-relative overflow-hidden"
              >
                <div class="decision-content position-relative z-1">
                  <div class="d-flex justify-content-between mb-3 text-white-50">
                    <span class="fs-xs fw-bold">{{
                      langService.isAr() ? 'قرار النظام' : 'System Decision'
                    }}</span>
                    <i class="bi bi-cpu"></i>
                  </div>
                  <h5 class="fw-bold text-white mb-3">
                    {{
                      langService.isAr()
                        ? 'تقليل المصاريف (Life/Flex)'
                        : 'Tighten Spending (Life/Flex)'
                    }}
                  </h5>
                  <p class="fs-xs text-white opacity-75 mb-4">
                    {{
                      langService.isAr()
                        ? 'بناءً على سلوكك المالي هذا الشهر، نوصي بهذا الإجراء لضمان استدامة ميزانيتك.'
                        : 'Based on your behavior, we recommend this for budget sustainability.'
                    }}
                  </p>
                  <button class="btn btn-white w-100 rounded-pill fw-bold py-2 shadow-sm">
                    {{ langService.isAr() ? 'تنفيذ القرار' : 'Execute Decision' }}
                  </button>
                </div>
                <i class="bi bi-stars position-absolute top-0 end-0 opacity-10 fs-1 m-2"></i>
              </div>
            </div>
          </div>
        </div>
      } @else {
        <!-- Empty State / Create Board -->
        <div
          class="text-center py-5 bg-white shadow-soft rounded-4 border border-dashed mx-auto"
          style="max-width: 600px"
        >
          <div class="mb-4">
            <i
              class="bi"
              [class.bi-calendar-x]="!isFutureDate"
              [class.bi-calendar-event]="isFutureDate"
              class="fs-1 text-secondary opacity-25"
            ></i>
          </div>

          @if (isFutureDate) {
            <h4 class="fw-bold mb-3">
              {{
                langService.isAr()
                  ? 'لا يمكن إنشاء لوحة تحكم لشهر مستقبلي'
                  : 'Cannot create dashboard for future month'
              }}
            </h4>
            <p class="text-secondary mb-0 px-4 small">
              {{
                langService.isAr()
                  ? 'يرجى العودة في الوقت المناسب لبدء تتبع التزاماتك لهذا الشهر.'
                  : 'Please come back at the right time to start tracking your obligations for this month.'
              }}
            </p>
          } @else {
            <h4 class="fw-bold mb-3">
              {{ langService.isAr() ? 'لا يوجد لوحة تحكم لهذا الشهر' : 'No board for this month' }}
            </h4>
            <p class="text-secondary mb-4 px-4 small">
              {{
                langService.isAr()
                  ? 'يمكنك إنشاء لوحة تحكم جديدة للبدء في تتبع التزاماتك المالية.'
                  : 'You can create a new dashboard to start tracking your financial obligations.'
              }}
            </p>
            <button
              class="btn btn-dark-felosy btn-lg rounded-pill px-5 fw-bold d-inline-flex align-items-center gap-2 shadow-lg"
              (click)="createBoard()"
            >
              <i class="bi bi-plus-lg"></i>
              <span>{{ langService.isAr() ? 'إنشاء لوحة تحكم' : 'Create Board' }}</span>
            </button>
          }
        </div>
      }
    </div>
  </div>

  <!-- Sidebar Wrapper -->
  <aside
    class="sidebar-wrapper transition-all bg-white border-start"
    [class.collapsed]="!isSidebarOpen()"
  >
    <div class="sidebar-sticky py-4 px-1 px-md-3">
      <app-timeline-sidebar
        [isOpen]="isSidebarOpen()"
        (toggleSidebar)="isSidebarOpen.set(!isSidebarOpen())"
      ></app-timeline-sidebar>
    </div>
  </aside>
</div>

<app-add-obligation-dialog
  *ngIf="showAddDialog()"
  (close)="showAddDialog.set(false)"
></app-add-obligation-dialog>
<app-setup-basic-info
  *ngIf="showSetupDialog()"
  (close)="showSetupDialog.set(false)"
></app-setup-basic-info>
